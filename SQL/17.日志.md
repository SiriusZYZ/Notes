

# 17.1ErrorLog错误日志

- 记录范围： 从mysqld 服务启动到停止过程中，在运行是发狠的任何严重错误的相关信息。
- 作用：当服务器出现任何故障时应首先查看此日志
- 开启情况：默认开启
- 查看: `cat /var/log/mysqld.log` 
- 错误日志有这些级别: `System`， `Warning` ，`ERROR`

```mysql
mysql> show variables like "%log_error%";
+----------------------------+----------------------------------------+
| Variable_name              | Value                                  |
+----------------------------+----------------------------------------+
| binlog_error_action        | ABORT_SERVER                           |
| log_error                  | /var/log/mysqld.log                    |
| log_error_services         | log_filter_internal; log_sink_internal |
| log_error_suppression_list |                                        |
| log_error_verbosity        | 2                                      |
+----------------------------+----------------------------------------+
5 rows in set (0.00 sec)
```

# 17.2BinLog二进制日志

- `binlog` 是二进制日志
- 内容：`binlog` 记录了任何会对数据产生更改的语句, 换而言之记录了所有的`DDL` 和`DML` 语句， 但不包括`DQL` 和`SHOW` 语句。
- 作用：因为记录了所有更改语句所以
  1. 灾难恢复
  2. MySQL 主从复制
- 相关配置: 
```mysql
mysql> show variables like "%log_bin%";
+---------------------------------+-----------------------------+
| Variable_name                   | Value                       |
+---------------------------------+-----------------------------+
| log_bin                         | ON                          |
| log_bin_basename                | /var/lib/mysql/binlog       |
| log_bin_index                   | /var/lib/mysql/binlog.index |
| log_bin_trust_function_creators | OFF                         |
| log_bin_use_v1_row_events       | OFF                         |
| sql_log_bin                     | ON                          |
+---------------------------------+-----------------------------+
6 rows in set (0.00 sec)
```

- `log_bin` 表示是否开启了二进制保存
- `log_bin_basename` 保存了 binlog文件的前缀(和路径)
- `log_bin_index` 行保存了 当前有的所有binlog的文件名
```shell
[root@sirius ~]# find /var/lib/mysql/ -name "binlog*"
/var/lib/mysql/binlog.000005
/var/lib/mysql/binlog.000004
/var/lib/mysql/binlog.index
/var/lib/mysql/binlog.000006
[root@sirius ~]# cat /var/lib/mysql/binlog.index
./binlog.000004
./binlog.000005
./binlog.000006
```

## 17.2.1|二进制日志格式


| 格式        | 含义                                         |
| ----------- | -------------------------------------------- |
| `STATEMENT` | 记录SQL语句的日志记录，记录的是SQL本身       |
| `ROW`       | 基于行的日志记录，记录每一行的数据变更(默认) |
| `MIXED`     | 混合以上两种方式，默认使用`STATEMENT`，在某些情况用`ROW`                                             |
- 查看方式: `SHOW VARIABLIES LIKE "%binlog_format%"`

```mysql
mysql> show variables like "%binlog_format%";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| binlog_format | ROW   |
+---------------+-------+
1 row in set (0.00 sec)
```
## 17.2.2|查看二进制日志内容
```shell
mysqlbinlog [-d -o -v -w] {binlog_file}
```
- 查看某一二进制日志文件内容
- d: 指定数据库名称，只列出该涉及数据库的操作
- o: 忽略前n行命令
- v: 重构为SQL语句
- w: 重构为SQL语句并显示注释


## 17.2.3|二进制文件删除
- 由于业务关系，可能会产生大量binlog，占用磁盘空间
```mysql
-- 删除全部日志
reset master

-- 删除binlog.*****前的日志
purge master logs to 'binlog.*****'

-- 删除某个时刻前的日志
purge master logs before 'yyyy-mm-dd hh24:mm:ss'
```


- 配置二进制文件过期时间:
```mysql
mysql> show variables like "%binlog_expire_logs_seconds%";
+----------------------------+---------+
| Variable_name              | Value   |
+----------------------------+---------+
| binlog_expire_logs_seconds | 2592000 |
+----------------------------+---------+
1 row in set (0.00 sec)

mysql> set global (session) binlog_expire_logs_seconds = ...;
```

# 17.3GeneralLog查询日志
- 内容：所有MySQL数据库请求的信息。
- 配置：默认关闭
- 位置: `/var/lib/mysql/DB-Server.log`
```mysql
mysql> show variables like '%general_log%';
+------------------+------------------------------+
| Variable_name    | Value                        |
+------------------+------------------------------+
| general_log      | OFF                          |
| general_log_file | /var/lib/mysql/DB-Server.log |
+------------------+------------------------------+
2 rows in set (0.00 sec)
```

- 查看内容， 查询日志保存在`mysql.general_log` 表中 :
```mysql
mysql> select * from mysql.general_log;
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
| event_time          | user_host                 | thread_id | server_id | command_type | argument                         |
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
| 2017-07-06 12:32:05 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like 'general%'   |
| 2017-07-06 12:32:28 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like 'log_output' |
| 2017-07-06 12:32:41 | root[root] @ localhost [] |         1 |         1 | Query        | select * from MyDB.test          |
| 2017-07-06 12:34:36 | [root] @ localhost []     |         3 |         1 | Connect      | root@localhost on                |
| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Query        | KILL QUERY 1                     |
| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Quit         |                                  |
| 2017-07-06 12:34:51 | root[root] @ localhost [] |         1 |         1 | Query        | select * from mysql.general_log  |
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
7 rows in set (0.02 sec)
```

# 17.4SlowQueryLog慢查询日志

- 内容：记录在 MySQL 中响应时间超过阀值的语句，具体指运行时间超过` long_query_time​ `值的SQL，则会被记录到慢查询日志中。
- `long_query_time` 的默认值为10，即说明超过10s以后才会被视为慢查询

- 查看慢查询配置相关的问题:
```mysql
-- 查看慢查询配置
mysql> show variables like '%slow_query_log%';
+-----------------------------------+--------------------------------+
| Variable_name                     | Value                          |
+-----------------------------------+--------------------------------+
| slow_query_log                    | OFF                             |
| slow_query_log_always_write_time  | 10.000000                      |
| slow_query_log_file               | /var/lib/mysql/sirius-slow.log  |
| slow_query_log_use_global_control |                                |
+-----------------------------------+--------------------------------+
4 rows in set (0.00 sec)

-- 查看阈值
mysql> show variables like '%long_query_time%';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)

-- 修改阈值
mysql> set global long_query_time = 1;
```
- `slow_query_log` 即是否开启了慢查询日志
- `slow_query_log_file` 即慢查询日志位置，和你的这个主机名有关系

