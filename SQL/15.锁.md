# 15.0总结
| 名称          | 作用域 | 速度 | 实现方式                                     | 风险点                                       |
| ------------- | ------ | ---- | -------------------------------------------- | -------------------------------------------- |
| 全局锁        | 库     | 快   | Flush tables with read lock (FTWRL)          | 业务暂停 |
| 表锁          | 表     | 快   | lock table ... read/write                    |                                              |
| 元数据锁(MDL) | 表     | 快   | 自动的，增删查改是加读锁，修改表结构时加写锁 | MDL锁没有锁超时时间                          |
| 页锁          | 页     | 中   | 锁某一数据库页，即部分相邻的数据行           |                                              |
| 行锁          | 行     | 慢   | 锁某一行数据，仅InnoDB支持                                             |                                              |

# 15.1全局锁
- **概念**：全局锁就是对整个数据库实例加锁。
- **应用场景**：全库逻辑备份（mysqldump）
- **风险**：
  1. **主库上**备份，那么在备份期间都不能执行更新，业务基本上就能停止。
  2. **从库上**备份，那么备份期间从库不能执行主库同步过来的binlog，会导致主从延迟。
```mysql
FLUSH TABLES WRITE READ LOCK 
```

# 15.2表锁及元数据锁

- 当前操作的整张表加锁，最常使用的 MyISAM 与 InnoDB 都支持表级锁定。
- MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。

**表锁：**
- `lock tables ... write` : 使得表不可写，但可读
- `lock tables ... read` : 使得表不可读写
- `unlock tables`: 解锁当前表

**MDL**
- **锁对象**：表结构
- **作用**：保证读写的正确性
- **加锁情况**：
  - MDL不需要显式调用，会自动加锁。
  1. 加读锁：当使用DML, DQL等不会修改表结构的时候
  2. 加写锁：当使用DDL 定义语言修改表结构时
  3. 解锁：当当前线程的当前事务完成了提交后释放锁
- **锁规则——写友好**
  1. 和普通文件类似，允许多个线程同时读。
  2. 读的时候不能写，写的时候不能读
  3. 仅一个线程可写
  4. **当一个写进程尝试加写锁时，阻塞所有后续读进程**
- **风险点**:由于其规则是写友好，所以一旦尝试修改表结构就会阻塞后来的所有增删查改请求。如果表很大，那修改表结构就要花很久，从而导致阻塞大量MDL读进程，可能导致库崩溃
- **解决风险的办法**：在高峰期暂缓所有DDL语句，必要时取消

# 15.3页锁

- **概念**：页级锁是 MySQL 中锁定粒度介于行级锁和表级锁中间的一种锁。
- 表级锁速度快，但冲突多，行级冲突少，但速度慢。因此，采取了折衷的页级锁，一次锁定相邻的一组记录。BDB 引擎支持页级锁。


# 15.4行锁

- **概念**：行级锁是粒度最低的锁，发生锁冲突的概率也最低、并发度最高。但是加锁慢、开销大，容易发生死锁现象。
- **引擎支持**：MySQL中只有InnoDB支持行级锁，行级锁分为共享锁和排他锁。
- **具体实现**：优先锁对应的主键索引
- **按性质划分类别**：
  1. **共享锁**： 允许多个线程同时读或加锁进程写，方法是在语句后加`lock in share mode`，该语句执行后该线程为对应数据行加锁
  2. **排他锁**： 仅允许加锁线程读写，可避免脏读，方法是在语句后加`for update`
- **按范围划分类别**
  - 一下所有锁都是排他锁的派生，语句特征是`for update`
  1. **记录锁**：当where 对应的结果是一行时为记录锁，只会锁一行
  2. **间隙锁**：当where对应的结果为多行时为间隙锁，锁多行
  3. **临键锁**：当where查询的东西是一个非唯一索引时，可能会锁一系列范围的东西，详细看不懂