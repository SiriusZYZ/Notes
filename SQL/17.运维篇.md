
# 17.1日志
## 17.1.1|ErrorLog错误日志

- 记录范围： 从mysqld 服务启动到停止过程中，在运行是发狠的任何严重错误的相关信息。
- 作用：当服务器出现任何故障时应首先查看此日志
- 开启情况：默认开启
- 查看: `cat /var/log/mysqld.log` 
- 错误日志有这些级别: `System`， `Warning` ，`ERROR`

```mysql
mysql> show variables like "%log_error%";
+----------------------------+----------------------------------------+
| Variable_name              | Value                                  |
+----------------------------+----------------------------------------+
| binlog_error_action        | ABORT_SERVER                           |
| log_error                  | /var/log/mysqld.log                    |
| log_error_services         | log_filter_internal; log_sink_internal |
| log_error_suppression_list |                                        |
| log_error_verbosity        | 2                                      |
+----------------------------+----------------------------------------+
5 rows in set (0.00 sec)
```

## 17.1.2BinLog二进制日志

- `binlog` 是二进制日志
- 内容：`binlog` 记录了任何会对数据产生更改的语句, 换而言之记录了所有的`DDL` 和`DML` 语句， 但不包括`DQL` 和`SHOW` 语句。
- 作用：因为记录了所有更改语句所以
  1. 灾难恢复
  2. MySQL 主从复制
- 相关配置: 
```mysql
mysql> show variables like "%log_bin%";
+---------------------------------+-----------------------------+
| Variable_name                   | Value                       |
+---------------------------------+-----------------------------+
| log_bin                         | ON                          |
| log_bin_basename                | /var/lib/mysql/binlog       |
| log_bin_index                   | /var/lib/mysql/binlog.index |
| log_bin_trust_function_creators | OFF                         |
| log_bin_use_v1_row_events       | OFF                         |
| sql_log_bin                     | ON                          |
+---------------------------------+-----------------------------+
6 rows in set (0.00 sec)
```

- `log_bin` 表示是否开启了二进制保存
- `log_bin_basename` 保存了 binlog文件的前缀(和路径)
- `log_bin_index` 行保存了 当前有的所有binlog的文件名
```shell
[root@sirius ~]# find /var/lib/mysql/ -name "binlog*"
/var/lib/mysql/binlog.000005
/var/lib/mysql/binlog.000004
/var/lib/mysql/binlog.index
/var/lib/mysql/binlog.000006
[root@sirius ~]# cat /var/lib/mysql/binlog.index
./binlog.000004
./binlog.000005
./binlog.000006
```

### 17.1.2.1|二进制日志格式


| 格式        | 含义                                         |
| ----------- | -------------------------------------------- |
| `STATEMENT` | 记录SQL语句的日志记录，记录的是SQL本身       |
| `ROW`       | 基于行的日志记录，记录每一行的数据变更(默认) |
| `MIXED`     | 混合以上两种方式，默认使用`STATEMENT`，在某些情况用`ROW`                                             |
- 查看方式: `SHOW VARIABLIES LIKE "%binlog_format%"`

```mysql
mysql> show variables like "%binlog_format%";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| binlog_format | ROW   |
+---------------+-------+
1 row in set (0.00 sec)
```
### 17.1.2.2|查看二进制日志内容
```shell
mysqlbinlog [-d -o -v -w] {binlog_file}
```
- 查看某一二进制日志文件内容
- d: 指定数据库名称，只列出该涉及数据库的操作
- o: 忽略前n行命令
- v: 重构为SQL语句
- w: 重构为SQL语句并显示注释


### 17.1.2.3|二进制文件删除
- 由于业务关系，可能会产生大量binlog，占用磁盘空间
```mysql
-- 删除全部日志
reset master

-- 删除binlog.*****前的日志
purge master logs to 'binlog.*****'

-- 删除某个时刻前的日志
purge master logs before 'yyyy-mm-dd hh24:mm:ss'
```


- 配置二进制文件过期时间:
```mysql
mysql> show variables like "%binlog_expire_logs_seconds%";
+----------------------------+---------+
| Variable_name              | Value   |
+----------------------------+---------+
| binlog_expire_logs_seconds | 2592000 |
+----------------------------+---------+
1 row in set (0.00 sec)

mysql> set global (session) binlog_expire_logs_seconds = ...;
```

## 17.1.3GeneralLog查询日志
- 内容：所有MySQL数据库请求的信息。
- 配置：默认关闭
- 位置: `/var/lib/mysql/DB-Server.log`
```mysql
mysql> show variables like '%general_log%';
+------------------+------------------------------+
| Variable_name    | Value                        |
+------------------+------------------------------+
| general_log      | OFF                          |
| general_log_file | /var/lib/mysql/DB-Server.log |
+------------------+------------------------------+
2 rows in set (0.00 sec)
```

- 查看内容， 查询日志保存在`mysql.general_log` 表中 :
```mysql
mysql> select * from mysql.general_log;
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
| event_time          | user_host                 | thread_id | server_id | command_type | argument                         |
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
| 2017-07-06 12:32:05 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like 'general%'   |
| 2017-07-06 12:32:28 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like 'log_output' |
| 2017-07-06 12:32:41 | root[root] @ localhost [] |         1 |         1 | Query        | select * from MyDB.test          |
| 2017-07-06 12:34:36 | [root] @ localhost []     |         3 |         1 | Connect      | root@localhost on                |
| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Query        | KILL QUERY 1                     |
| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Quit         |                                  |
| 2017-07-06 12:34:51 | root[root] @ localhost [] |         1 |         1 | Query        | select * from mysql.general_log  |
+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+
7 rows in set (0.02 sec)
```

## 17.1.4SlowQueryLog慢查询日志

- 内容：记录在 MySQL 中响应时间超过阀值的语句，具体指运行时间超过` long_query_time​ `值的SQL，则会被记录到慢查询日志中。
- `long_query_time` 的默认值为10，即说明超过10s以后才会被视为慢查询

- 查看慢查询配置相关的问题:
```mysql
-- 查看慢查询配置
mysql> show variables like '%slow_query_log%';
+-----------------------------------+--------------------------------+
| Variable_name                     | Value                          |
+-----------------------------------+--------------------------------+
| slow_query_log                    | OFF                             |
| slow_query_log_always_write_time  | 10.000000                      |
| slow_query_log_file               | /var/lib/mysql/sirius-slow.log  |
| slow_query_log_use_global_control |                                |
+-----------------------------------+--------------------------------+
4 rows in set (0.00 sec)

-- 查看阈值
mysql> show variables like '%long_query_time%';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)

-- 修改阈值
mysql> set global long_query_time = 1;
```
- `slow_query_log` 即是否开启了慢查询日志
- `slow_query_log_file` 即慢查询日志位置，和你的这个主机名有关系


# 17.2主从复制

- **含义：** 指数据可以从一个 MySQL 数据库服务器主节点(master)复制到一个或多个从节点(slave)。
- **复制的方式**： 默认采用异步复制方式，这样**从节点不用一直访问主服务器来更新自己的数据**，数据的更新可以在远程连接上进行，
- **复制的内容**：从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。

- **主从复制的原则**：
  - 每个slave只有一个master
  - 每个slave只能有一个唯一的服务器ID
  - 每个master可以有多个salve

## 17.2.1|主从复制的原理
![](../assets/Pasted%20image%2020230905161614.png)
1. 从`master`服务器的`binlog` 中知晓数据变更情况
2. `slave` 发现 如果`binlog` 在上一次复制到现在发生了改变，就说明，主服务器更新了，需要更新`slave`的内容。
3. `slave` 开启两个线程
   - 创造一个 `I/O thread` 用来请求`master` 的`binlog`，把其中的内容更新到自己的`relay-log`(中继日志)中
   - 创造一个 `SQL thread` 用来将`relay-log` 中的内容转译成SQL语句并更新到`slave` 自己的数据库中
4. `master` 开启一个新的线程
   - 创造一个`dump` 线程用来给`slave` 的 `I/O thread` 提供主的`binlog` 数据
## 17.2.2|具体步骤


1. **连接主库**：从库通过手工执行 `change master to` 语句，提供了连接的用户一切条件如用户名、密码、主机、端口号。并同时获取 `master binlog` 的起点位置，包括`binlog` 文件名和`position` 号
   ```mysql
CHANGE MASTER TO 
	MASTER_HOST='主服务器IP', 
	MASTER_USER='创建用户名',
	MASTER_PASSWORD='创建的密码', 
	MASTER_LOG_FILE='File 名字',  -- 首个 binlog 文件
	MASTER_LOG_POS=Position 数字; -- binlog 文件对应的首条未复制的修改记录
```
2. **启动主从复制** : `start slave`
3. **从库IO线程与主库dump线程连接**： `slave::I/O thread` 向 `master` 申请`binlog + position`  请求，`master::dump` 向 `slave::I/O thread` 以事件的方式发送响应
4. **从库IO线程将数据操作写入中继日志**
5. **从库写数据**：`slave::MySQL thread` 转译`relay-log` 为一条条MySQL语句，并执行以修改`slave` 的数据，并把应用过的记录放到`relay-log.info` 中，已经用过的relay会被自动清理 
6. **监视本次主从复制**: `show slave status;` 该命令为非交互式
7. **结束本次主从复制**：`stop slave;`

## 17.2.3|主从复制的形式
1. 一主一丛
2. 主主复制
3. 一主多从
4. 多主一从
5. 级联复制


# 17.3分库分表

- **理解：** 将一个大型数据库分成多个较小的数据库（分库），并将每个数据库的数据进一步分成多个较小的表（分表），每个表只包含部分数据。
- 这种方式使得**查询和更新操作可以在多个数据库和表之间并行执行**，提高了系统的扩展性和性能。

## 17.3.1|实现原理

**分库分表**:
1. **确定分库分表的策略**：使用一定的规则将原始的一整块数据分散到多个数据库和表中
2. **相同的结构**： 对每个分分表库使用相同的表结构，可以看作是相同类型的数据表，查询、更新等语句也能在其中快速的进行
3. **逻辑上的统一**：使用分库分表的中间件，将分库分表组成逻辑上的整体对外提供服务

**分库分表中间件功能**：
1. **实现上**： 对数据库和表进行自动切分和合并
2. **操作上**：对SQL语句自动路由 (就是导向哪一个表) 和查询结果合并
3. **容灾上**： 对数据提供备份和恢复功能
4. **事务上**： 提供对事务的支持


## 17.3.2|常见策略

1. **垂直分表**：
   - 按行划分，即每一个表都包含了